---
title: 数据程序处理
date: 2025-03-30 10:43:06
categories: 
  - 编程技术
  - 指标与量化
tags:
  - Python
  - 期货
---

## 席位净持仓分析

```python
import requests
import datetime
from pyecharts.charts import Line, Kline, Grid
from pyecharts import options as opts
from typing import List, Dict, Any
import os

cookies = {"PHPSESSID": "99c4b9acf254a1afb81ce56158836206"}
url = "https://www.jiaoyikecha.com/ajax/variety_net_position.php"
# 配置
variety = "20号胶"
brokers = ["中信期货", "东证期货", "国泰君安", "永安期货", "海通期货", "华泰期货"]
# brokers = ["乾坤期货", "瑞银期货", "摩根大通"]
# brokers = ["东方财富", "徽商期货", "平安期货", "中信建投"]


def buildData(variety: str, brokers: List[str], length: int) -> Dict[str, List[Any]]:
    data = {"dates": [], "kData": []}
    allSum = [0 for i in range(length)]
    for i, strItem in enumerate(brokers):
        responseData = requests.post(
            url,
            data={
                "variety": variety,
                "brokers[]": [strItem],
            },
            cookies=cookies,
        ).json()["data"]
        if i == 0:
            data["dates"] = responseData["dates"][-length:]
            data["kData"] = responseData["infos"][-length:]
        values = responseData["values"][-length:]
        allSum = [x + y for x, y in zip(values, allSum)]
        data[strItem] = values
    data["AllSum"] = allSum
    return data

def drawGraph(variety: str, sourceData: Dict[str, List[Any]], brokers: List[str]):
    subtitle = " || ".join(
        f"{broker}净增减：{int(sourceData[broker][-1]) - int(sourceData[broker][-2])}"
        for broker in brokers
    )
    brokenLine = Line().set_global_opts(
        title_opts=opts.TitleOpts(
            title=variety+"净持仓席位分析",
            subtitle=subtitle,
            pos_left="10%",
        ),
        tooltip_opts=opts.TooltipOpts(
            trigger="axis",
            axis_pointer_type="cross",
            background_color="rgba(245, 245, 245, 0.8)",
            border_width=1,
            border_color="#ccc",
            textstyle_opts=opts.TextStyleOpts(color="#000"),
        ),
        legend_opts=opts.LegendOpts(type_="scroll")
    )
    brokenLine.add_xaxis(xaxis_data=sourceData["dates"])
    for strItem in brokers:
        brokenLine.add_yaxis(series_name=strItem, y_axis=sourceData[strItem], label_opts=opts.LabelOpts(is_show=False), is_symbol_show=False)
    brokenLine.add_yaxis(series_name="席位加和", y_axis=sourceData["AllSum"], label_opts=opts.LabelOpts(is_show=False), is_symbol_show=False)

    kLine = Kline().set_global_opts()
    kLine.add_xaxis(xaxis_data=sourceData["dates"])
    kLine.add_yaxis(series_name="", y_axis=sourceData["kData"])

    todayDate = datetime.datetime.now().strftime("%Y-%m-%d")
    outputDir = "席位净持仓分析"
    os.makedirs(outputDir, exist_ok=True)
    outputFilename = f"{todayDate} {variety}.html"
    renderPath = os.path.join(outputDir, outputFilename)
    Grid(init_opts=opts.InitOpts(renderer="svg", width="95vw", height="90vh")).add(brokenLine, grid_opts=opts.GridOpts(is_show=True, height="45%")).add(kLine, grid_opts=opts.GridOpts(is_show=True, pos_bottom="10%", height="30%")).render(renderPath)


data = buildData(variety, brokers, 70)
drawGraph(variety, data, brokers)
```